<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³å£°è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s ease;
        }
        .audio-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        .audio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }
        audio {
            width: 300px;
        }
        
        /* è¡¨å½¢å¼ã®è©•ä¾¡UI */
        .evaluation-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background: white;
        }
        .evaluation-table th,
        .evaluation-table td {
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .evaluation-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            font-size: 14px;
        }
        .evaluation-table .item-name {
            text-align: left;
            font-weight: bold;
            background-color: #fafafa;
            min-width: 120px;
        }
        .evaluation-table .scale-labels {
            background-color: #fafafa;
            font-size: 12px;
            font-weight: normal;
        }
        .evaluation-table .radio-cell {
            width: 40px;
            padding: 8px;
        }
        .evaluation-table input[type="radio"] {
            transform: scale(1.2);
            cursor: pointer;
        }
        .evaluation-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .evaluation-table tr:hover {
            background-color: #f0f8ff;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .completion-screen {
            text-align: center;
            padding: 40px;
            display: none;
        }
        .completion-screen h2 {
            color: #4CAF50;
            margin-bottom: 20px;
        }
        .results-summary {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .instruction {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
        .info-form {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }
        .form-group label {
            min-width: 80px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .start-screen {
            text-align: center;
        }
        .evaluation-warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
            text-align: center;
        }
        
        /* ãƒ‡ãƒãƒƒã‚°æƒ…å ± */
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 12px;
            color: #495057;
            /* ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šæœ¬ç•ªã§ã¯ display: none; ã«ã™ã‚‹ */
            display: block;
        }
        .debug-info.hidden {
            display: none;
        }
        .debug-info h4 {
            margin: 0 0 10px 0;
            color: #007bff;
            font-family: inherit;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>éŸ³å£°è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ </h1>
            <div class="instruction">
                <strong>è©•ä¾¡æ–¹æ³•ï¼š</strong> å„éŸ³å£°ã‚’èã„ã¦ã€13é …ç›®ã«ã¤ã„ã¦-3ã‹ã‚‰+3ã®7æ®µéšã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚<br>
                éŸ³å£°ã¯ä½•åº¦ã§ã‚‚å†ç”Ÿå¯èƒ½ã§ã™ã€‚ã™ã¹ã¦ã®é …ç›®ã‚’è©•ä¾¡ã—ã¦ã‹ã‚‰æ¬¡ã«é€²ã‚“ã§ãã ã•ã„ã€‚
            </div>
        </div>

        <div id="start-screen" class="start-screen">
            <div class="info-form">
                <h3>åŸºæœ¬æƒ…å ±ï¼ˆä»»æ„ï¼‰</h3>
                <div class="form-group">
                    <label for="age">å¹´é½¢ï¼š</label>
                    <input type="number" id="age" min="1" max="120" placeholder="ä¾‹ï¼š25">
                </div>
                <div class="form-group">
                    <label for="gender">æ€§åˆ¥ï¼š</label>
                    <select id="gender">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="male">ç”·æ€§</option>
                        <option value="female">å¥³æ€§</option>
                        <option value="other">ãã®ä»–</option>
                        <option value="not_specified">å›ç­”ã—ãªã„</option>
                    </select>
                </div>
            </div>
            <button class="btn" onclick="startEvaluation()">è©•ä¾¡ã‚’é–‹å§‹</button>
        </div>

        <div id="evaluation-screen" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div id="progress-text">ã‚µãƒ³ãƒ—ãƒ« 1 / 10</div>

            <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
            <div class="debug-info" id="debug-info">
                <h4>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h4>
                <div id="debug-content">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>

            <div class="audio-section">
                <div class="audio-controls">
                    <audio id="audio-player" controls preload="auto">
                        <source id="audio-source" src="" type="audio/wav">
                        ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°ã®å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
                    </audio>
                    <button class="btn btn-secondary" onclick="replayAudio()">å†ç”Ÿ</button>
                </div>
            </div>

            <div class="evaluation-warning" id="evaluation-warning" style="display: none;">
                ã™ã¹ã¦ã®è©•ä¾¡é …ç›®ã«ãŠç­”ãˆãã ã•ã„
            </div>

            <!-- è¡¨å½¢å¼ã®è©•ä¾¡UI -->
            <table class="evaluation-table" id="evaluation-table">
                <thead>
                    <tr>
                        <th rowspan="2" class="item-name">è©•ä¾¡é …ç›®</th>
                        <th colspan="7">è©•ä¾¡ã‚¹ã‚±ãƒ¼ãƒ«</th>
                        <th rowspan="2" class="item-name">è©•ä¾¡é …ç›®</th>
                    </tr>
                    <tr>
                        <th class="scale-labels">-3</th>
                        <th class="scale-labels">-2</th>
                        <th class="scale-labels">-1</th>
                        <th class="scale-labels">0</th>
                        <th class="scale-labels">1</th>
                        <th class="scale-labels">2</th>
                        <th class="scale-labels">3</th>
                    </tr>
                </thead>
                <tbody id="evaluation-tbody">
                    <!-- è©•ä¾¡é …ç›®ã¯å‹•çš„ã«ç”Ÿæˆ -->
                </tbody>
            </table>

            <div class="navigation">
                <button class="btn btn-secondary" id="prev-btn" onclick="previousSample()" disabled>å‰ã®ã‚µãƒ³ãƒ—ãƒ«</button>
                <div id="sample-counter">ã‚µãƒ³ãƒ—ãƒ« 1 / 10</div>
                <button class="btn" id="next-btn" onclick="nextSample()" disabled>æ¬¡ã®ã‚µãƒ³ãƒ—ãƒ«</button>
            </div>
        </div>

        <div class="completion-screen" id="completion-screen">
            <h2>ğŸ‰ è©•ä¾¡å®Œäº†ï¼</h2>
            <p>10å€‹ã™ã¹ã¦ã®éŸ³å£°ã‚µãƒ³ãƒ—ãƒ«ã®è©•ä¾¡ãŒå®Œäº†ã—ã¾ã—ãŸã€‚</p>
            <div class="results-summary">
                <h3>çµæœæ¦‚è¦</h3>
                <p>è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã¯GitHub Gistã«è‡ªå‹•ä¿å­˜ã•ã‚Œã€åŒæ™‚ã«CSVå½¢å¼ã§ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚</p>
                <p>ãƒ‡ãƒ¼ã‚¿ã«ã¯è©•ä¾¡æ™‚åˆ»ã€éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã€å„è©•ä¾¡é …ç›®ã®å€¤ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚</p>
                <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 14px;">
                    <strong>ğŸ“ è¨­å®šãŒå¿…è¦ï¼š</strong> ã‚³ãƒ¼ãƒ‰å†…ã® <code>YOUR_GITHUB_TOKEN</code> ã‚’å®Ÿéš›ã®GitHub Personal Access Tokenã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
                </div>
            </div>
            <button class="btn" onclick="downloadResults()">çµæœã‚’ä¿å­˜ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <button class="btn btn-secondary" onclick="restartEvaluation()">è©•ä¾¡ã‚’ã‚„ã‚Šç›´ã™</button>
        </div>
    </div>

    <script>
        // è©•ä¾¡é …ç›®ã®å®šç¾©
        const evaluationItems = [
            {
                "Name": "æ©Ÿæ¢°çš„ãªå£°",
                "Min": -3,
                "Max": 3,
                "Step": 1,
                "MinLabel": "æ©Ÿæ¢°çš„ãªå£°",
                "MaxLabel": "è‡ªç„¶ãªå£°"
            },
            {
                "Name": "ä½ã„å£°",
                "Min": -3,
                "Max": 3,
                "Step": 1,
                "MinLabel": "ä½ã„å£°",
                "MaxLabel": "é«˜ã„å£°"
            },
            {
                "Name": "ãƒ¢ãƒ–æ„Ÿã®ã‚ã‚‹å£°",
                "Min": -3,
                "Max": 3,
                "Step": 1,
                "MinLabel": "ãƒ¢ãƒ–æ„Ÿã®ã‚ã‚‹å£°",
                "MaxLabel": "ãƒªãƒ¼ãƒ€ãƒ¼æ„Ÿã®ã‚ã‚‹å£°"
            },
            {
                "Name": "è¡¨ç¾åŠ›ã®ãªã„å£°",
                "Min": -3,
                "Max": 3,
                "Step": 1,
                "MinLabel": "è¡¨ç¾åŠ›ã®ãªã„å£°",
                "MaxLabel": "è¡¨ç¾åŠ›ã®ã‚ã‚‹å£°"
            },
            {
                "Name": "è€ã„",
                "Min": -3,
                "Max": 3,
                "Step": 1,
                "MinLabel": "è€ã„",
                "MaxLabel": "è‹¥ã„"
            },
            {
                "Name": "ãã³ã—ã„",
                "Min": -3,
                "Max": 3,
                "Step": 1,
                "MinLabel": "ãã³ã—ã„",
                "MaxLabel": "ã‚„ã™ã‚‰ã‹"
            },
            {
                "Name": "ä¿¡é ¼ã§ããªã„",
                "Min": -3,
                "Max": 3,
                "Step": 1,
                "MinLabel": "ä¿¡é ¼ã§ããªã„",
                "MaxLabel": "ä¿¡é ¼ã§ãã‚‹"
            },
            {
                "Name": "ãƒ–ã‚µãƒœ",
                "Min": -3,
                "Max": 3,
                "Step": 1,
                "MinLabel": "ãƒ–ã‚µãƒœ",
                "MaxLabel": "ã‚¤ã‚±ãƒœ"
            },
            {
                "Name": "èãã¥ã‚‰ã„",
                "Min": -3,
                "Max": 3,
                "Step": 1,
                "MinLabel": "èãã¥ã‚‰ã„",
                "MaxLabel": "èãã‚„ã™ã„"
            },
            {
                "Name": "ç„¡å€‹æ€§",
                "Min": -3,
                "Max": 3,
                "Step": 1,
                "MinLabel": "ç„¡å€‹æ€§",
                "MaxLabel": "å€‹æ€§çš„ã§ã‚ã‚‹"
            },
            {
                "Name": "ã‚¢ãƒ„ã„å£°",
                "Min": -3,
                "Max": 3,
                "Step": 1,
                "MinLabel": "ã‚¢ãƒ„ã„å£°",
                "MaxLabel": "çˆ½ã‚„ã‹ãªå£°"
            },
            {
                "Name": "å®‰å®šæ„Ÿã®ãªã„å£°",
                "Min": -3,
                "Max": 3,
                "Step": 1,
                "MinLabel": "å®‰å®šæ„Ÿã®ãªã„å£°",
                "MaxLabel": "å®‰å®šæ„Ÿã®ã‚ã‚‹å£°"
            },
            {
                "Name": "éŸ³ã®éŸ¿ããªã—",
                "Min": -3,
                "Max": 3,
                "Step": 1,
                "MinLabel": "éŸ³ã®éŸ¿ããªã—",
                "MaxLabel": "éŸ³ã®éŸ¿ãã‚ã‚Š"
            }
        ];

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentSampleIndex = 0;
        let audioSamples = [];
        let evaluationResults = [];
        let currentEvaluations = {};
        let userInfo = {};

        // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã®ç”Ÿæˆï¼ˆV1â†’V2ã®é †åºã§å®Ÿè¡Œï¼‰
        function generateAudioFileList() {
            const audioFiles = [];
            const rates = ['0.5', '0.75', '1.0', '1.25', '1.5'];
            
            // V1ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠï¼ˆ1-5ï¼‰
            const v1AudioNumber = Math.floor(Math.random() * 5) + 1;
            
            // V2ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠï¼ˆ6-10ï¼‰
            const v2AudioNumbers = [6, 7, 8, 9, 10];
            const v2AudioNumber = v2AudioNumbers[Math.floor(Math.random() * v2AudioNumbers.length)];
            // V2ã®ãƒ•ã‚¡ã‚¤ãƒ«åç”¨ã®ç•ªå·ï¼ˆaudio6â†’1, audio7â†’2, audio8â†’3, audio9â†’4, audio10â†’5ï¼‰
            const v2FileNumber = v2AudioNumber - 5;
            
            // V1ã®ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆï¼ˆæœ€åˆã®5ã‚µãƒ³ãƒ—ãƒ«ï¼‰
            rates.forEach(rate => {
                const fileName = `V1-${v1AudioNumber}-${rate}.wav`;
                audioFiles.push({
                    version: 'V1',
                    audioNumber: v1AudioNumber,
                    rate: rate,
                    fileName: fileName,
                    path: `audio/V1/audio${v1AudioNumber}/${fileName}`
                });
            });
            
            // V1å†…ã§ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            const v1Files = shuffleArray([...audioFiles]);
            
            // V2ã®ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆï¼ˆæ¬¡ã®5ã‚µãƒ³ãƒ—ãƒ«ï¼‰
            const v2Files = [];
            rates.forEach(rate => {
                const fileName = `V2-${v2FileNumber}-${rate}.wav`;
                v2Files.push({
                    version: 'V2',
                    audioNumber: v2AudioNumber,
                    fileNumber: v2FileNumber,
                    rate: rate,
                    fileName: fileName,
                    path: `audio/V2/audio${v2AudioNumber}/${fileName}`
                });
            });
            
            // V2å†…ã§ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            const shuffledV2Files = shuffleArray(v2Files);
            
            // V1â†’V2ã®é †åºã§çµåˆ
            return [...v1Files, ...shuffledV2Files];
        }

        // é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹é–¢æ•°
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®æ›´æ–°
        function updateDebugInfo() {
            if (audioSamples.length === 0) return;
            
            const sample = audioSamples[currentSampleIndex];
            const debugContent = `
                <strong>ç¾åœ¨ã®éŸ³å£°:</strong> ${sample.fileName}<br>
                <strong>ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</strong> ${sample.version}<br>
                <strong>ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªç•ªå·:</strong> ${sample.audioNumber}<br>
                ${sample.fileNumber ? `<strong>ãƒ•ã‚¡ã‚¤ãƒ«ç•ªå·:</strong> ${sample.fileNumber}<br>` : ''}
                <strong>å†ç”Ÿé€Ÿåº¦:</strong> ${sample.rate}x<br>
                <strong>ãƒ‘ã‚¹:</strong> ${sample.path}<br>
                <strong>ã‚µãƒ³ãƒ—ãƒ«ç•ªå·:</strong> ${currentSampleIndex + 1} / ${audioSamples.length}
            `;
            document.getElementById('debug-content').innerHTML = debugContent;
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆï¼ˆæœ¬ç•ªæ™‚ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
        function toggleDebugMode() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.classList.toggle('hidden');
        }

        // è©•ä¾¡é–‹å§‹
        function startEvaluation() {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜
            userInfo.age = document.getElementById('age').value || null;
            userInfo.gender = document.getElementById('gender').value || null;
            
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('evaluation-screen').style.display = 'block';
            
            initializeEvaluation();
        }

        // åˆæœŸåŒ–
        function initializeEvaluation() {
            audioSamples = generateAudioFileList();
            evaluationResults = [];
            currentSampleIndex = 0;
            currentEvaluations = {};
            
            generateEvaluationTable();
            loadCurrentSample();
            updateProgress();
        }

        // è¡¨å½¢å¼ã®è©•ä¾¡UIã‚’ç”Ÿæˆ
        function generateEvaluationTable() {
            const tbody = document.getElementById('evaluation-tbody');
            tbody.innerHTML = '';
            
            evaluationItems.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // å·¦ã®é …ç›®å
                const leftLabelCell = document.createElement('td');
                leftLabelCell.className = 'item-name';
                leftLabelCell.textContent = item.MinLabel;
                row.appendChild(leftLabelCell);
                
                // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼ˆ-3 ã‹ã‚‰ 3ï¼‰
                for (let value = item.Min; value <= item.Max; value++) {
                    const cell = document.createElement('td');
                    cell.className = 'radio-cell';
                    
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `evaluation-${index}`;
                    radio.value = value;
                    radio.onchange = () => updateEvaluation(index, value);
                    
                    cell.appendChild(radio);
                    row.appendChild(cell);
                }
                
                // å³ã®é …ç›®å
                const rightLabelCell = document.createElement('td');
                rightLabelCell.className = 'item-name';
                rightLabelCell.textContent = item.MaxLabel;
                row.appendChild(rightLabelCell);
                
                tbody.appendChild(row);
            });
        }

        // è©•ä¾¡å€¤ã®æ›´æ–°
        function updateEvaluation(itemIndex, value) {
            currentEvaluations[itemIndex] = parseInt(value);
            
            // ã™ã¹ã¦ã®é …ç›®ãŒè©•ä¾¡ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const allEvaluated = Object.keys(currentEvaluations).length === evaluationItems.length;
            document.getElementById('next-btn').disabled = !allEvaluated;
            
            const warningElement = document.getElementById('evaluation-warning');
            if (allEvaluated) {
                warningElement.style.display = 'none';
            } else {
                warningElement.style.display = 'block';
            }
        }

        // ç¾åœ¨ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’èª­ã¿è¾¼ã¿
        function loadCurrentSample() {
            const sample = audioSamples[currentSampleIndex];
            document.getElementById('audio-source').src = sample.path;
            document.getElementById('audio-player').load();
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°
            updateDebugInfo();
            
            // è©•ä¾¡å€¤ã‚’ãƒªã‚»ãƒƒãƒˆ
            currentEvaluations = {};
            
            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆ
            evaluationItems.forEach((item, index) => {
                const radios = document.querySelectorAll(`input[name="evaluation-${index}"]`);
                radios.forEach(radio => radio.checked = false);
            });
            
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            document.getElementById('prev-btn').disabled = currentSampleIndex === 0;
            document.getElementById('next-btn').disabled = true;
            document.getElementById('evaluation-warning').style.display = 'block';
        }

        // é€²æ—ã®æ›´æ–°
        function updateProgress() {
            const progress = ((currentSampleIndex + 1) / audioSamples.length) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-text').textContent = `ã‚µãƒ³ãƒ—ãƒ« ${currentSampleIndex + 1} / ${audioSamples.length}`;
            document.getElementById('sample-counter').textContent = `ã‚µãƒ³ãƒ—ãƒ« ${currentSampleIndex + 1} / ${audioSamples.length}`;
        }

        // æ¬¡ã®ã‚µãƒ³ãƒ—ãƒ«ã¸
        function nextSample() {
            // ã™ã¹ã¦ã®é …ç›®ãŒè©•ä¾¡ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (Object.keys(currentEvaluations).length !== evaluationItems.length) {
                document.getElementById('evaluation-warning').style.display = 'block';
                return;
            }

            // ç¾åœ¨ã®è©•ä¾¡ã‚’ä¿å­˜
            const sample = audioSamples[currentSampleIndex];
            const result = {
                timestamp: new Date().toISOString(),
                sampleIndex: currentSampleIndex,
                audioFile: sample.fileName,
                version: sample.version,
                audioNumber: sample.audioNumber,
                fileNumber: sample.fileNumber || null,
                rate: sample.rate,
                path: sample.path,
                evaluations: evaluationItems.map((_, index) => currentEvaluations[index])
            };
            
            evaluationResults.push(result);
            
            // æ¬¡ã®ã‚µãƒ³ãƒ—ãƒ«ã¸
            currentSampleIndex++;
            
            if (currentSampleIndex >= audioSamples.length) {
                // è©•ä¾¡å®Œäº†
                showCompletionScreen();
            } else {
                loadCurrentSample();
                updateProgress();
            }
        }

        // å‰ã®ã‚µãƒ³ãƒ—ãƒ«ã¸
        function previousSample() {
            if (currentSampleIndex > 0) {
                currentSampleIndex--;
                
                // å‰ã®è©•ä¾¡çµæœã‚’å¾©å…ƒ
                const previousResult = evaluationResults[currentSampleIndex];
                if (previousResult) {
                    // è©•ä¾¡å€¤ã‚’å¾©å…ƒ
                    currentEvaluations = {};
                    previousResult.evaluations.forEach((value, index) => {
                        currentEvaluations[index] = value;
                        const radio = document.querySelector(`input[name="evaluation-${index}"][value="${value}"]`);
                        if (radio) radio.checked = true;
                    });
                    
                    document.getElementById('next-btn').disabled = false;
                    document.getElementById('evaluation-warning').style.display = 'none';
                }
                
                loadCurrentSample();
                updateProgress();
            }
        }

        // éŸ³å£°å†ç”Ÿ
        function replayAudio() {
            const audio = document.getElementById('audio-player');
            audio.currentTime = 0;
            audio.play();
        }

        // å®Œäº†ç”»é¢ã‚’è¡¨ç¤º
        function showCompletionScreen() {
            document.getElementById('evaluation-screen').style.display = 'none';
            document.getElementById('completion-screen').style.display = 'block';
        }

        // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆæ–‡å­—åŒ–ã‘å¯¾ç­–ç‰ˆï¼‰
        function downloadResultsAsCSV(resultData) {
            const headers = ['Timestamp', 'Age', 'Gender', 'SampleIndex', 'AudioFile', 'Version', 'AudioNumber', 'FileNumber', 'Rate', 'Path', 
                            ...evaluationItems.map(item => item.Name)];
            
            // BOMä»˜ãUTF-8ã§CSVä½œæˆï¼ˆExcelå¯¾å¿œï¼‰
            const csvContent = [headers.join(',')];
            
            resultData.results.forEach(result => {
                const row = [
                    `"${result.timestamp}"`,
                    `"${resultData.userInfo.age || ''}"`,
                    `"${resultData.userInfo.gender || ''}"`,
                    result.sampleIndex,
                    `"${result.audioFile}"`,
                    `"${result.version}"`,
                    result.audioNumber,
                    result.fileNumber || '',
                    result.rate,
                    `"${result.path}"`,
                    ...result.evaluations
                ];
                csvContent.push(row.join(','));
            });
            
            // BOMä»˜ãã§Blobä½œæˆ
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `voice_evaluation_results_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // GitHubãƒªãƒã‚¸ãƒˆãƒªã«CSVã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
        async function saveResultsToGitHub(resultData) {
            try {
                const headers = ['Timestamp', 'Age', 'Gender', 'SampleIndex', 'AudioFile', 'Version', 'AudioNumber', 'FileNumber', 'Rate', 'Path', 
                                ...evaluationItems.map(item => item.Name)];
                
                const csvContent = [headers.join(',')];
                
                resultData.results.forEach(result => {
                    const row = [
                        `"${result.timestamp}"`,
                        `"${resultData.userInfo.age || ''}"`,
                        `"${resultData.userInfo.gender || ''}"`,
                        result.sampleIndex,
                        `"${result.audioFile}"`,
                        `"${result.version}"`,
                        result.audioNumber,
                        result.fileNumber || '',
                        result.rate,
                        `"${result.path}"`,
                        ...result.evaluations
                    ];
                    csvContent.push(row.join(','));
                });
                
                const BOM = '\uFEFF';
                const csvString = BOM + csvContent.join('\n');
                
                // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯IDä»˜ãï¼‰
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const uniqueId = Math.random().toString(36).substr(2, 9);
                const filename = `voice_evaluation_${timestamp}_${uniqueId}.csv`;
                
                // GitHub Issues APIã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                const issueData = {
                    title: `éŸ³å£°è©•ä¾¡çµæœ - ${timestamp}`,
                    body: `## éŸ³å£°è©•ä¾¡çµæœãƒ‡ãƒ¼ã‚¿\n\n**ãƒ•ã‚¡ã‚¤ãƒ«å:** ${filename}  \n**è©•ä¾¡æ™‚åˆ»:** ${resultData.timestamp}  \n**å¹´é½¢:** ${resultData.userInfo.age || 'æœªå…¥åŠ›'}  \n**æ€§åˆ¥:** ${resultData.userInfo.gender || 'æœªå…¥åŠ›'}  \n**ç·ã‚µãƒ³ãƒ—ãƒ«æ•°:** ${resultData.totalSamples}\n\n### CSVãƒ‡ãƒ¼ã‚¿\n\`\`\`csv\n${csvString}\n\`\`\``,
                    labels: ['evaluation-data']
                };
                
                // GitHubãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ï¼ˆè¨­å®šãŒå¿…è¦ï¼‰
                const GITHUB_REPO_OWNER = 'sakurarogu'; // ã“ã“ã‚’å¤‰æ›´
                const GITHUB_REPO_NAME = 'voice-evaluation-system'; // ã“ã“ã‚’å¤‰æ›´
                const GITHUB_TOKEN = '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'; // GitHub Personal Access TokenãŒå¿…è¦
                
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/issues`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(issueData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('GitHubä¿å­˜æˆåŠŸ:', result);
                    showSaveSuccess('GitHub');
                    return true;
                } else {
                    throw new Error(`GitHub API ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }
                
            } catch (error) {
                console.error('GitHubä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showSaveError('GitHub', error.message);
                return false;
            }
        }

        // ã‚ˆã‚Šè‰¯ã„æ–¹æ³•ï¼šGitHub Gistã‚’ä½¿ç”¨
        async function saveResultsToGitHubGist(resultData) {
            try {
                const headers = ['Timestamp', 'Age', 'Gender', 'SampleIndex', 'AudioFile', 'Version', 'AudioNumber', 'FileNumber', 'Rate', 'Path', 
                                ...evaluationItems.map(item => item.Name)];
                
                const csvContent = [headers.join(',')];
                
                resultData.results.forEach(result => {
                    const row = [
                        `"${result.timestamp}"`,
                        `"${resultData.userInfo.age || ''}"`,
                        `"${resultData.userInfo.gender || ''}"`,
                        result.sampleIndex,
                        `"${result.audioFile}"`,
                        `"${result.version}"`,
                        result.audioNumber,
                        result.fileNumber || '',
                        result.rate,
                        `"${result.path}"`,
                        ...result.evaluations
                    ];
                    csvContent.push(row.join(','));
                });
                
                const BOM = '\uFEFF';
                const csvString = BOM + csvContent.join('\n');
                
                // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const uniqueId = Math.random().toString(36).substr(2, 9);
                const filename = `voice_evaluation_${timestamp}_${uniqueId}.csv`;
                
                // Gistãƒ‡ãƒ¼ã‚¿
                const gistData = {
                    description: `éŸ³å£°è©•ä¾¡çµæœ - ${timestamp}`,
                    public: false, // privateã«è¨­å®š
                    files: {
                        [filename]: {
                            content: csvString
                        },
                        "metadata.json": {
                            content: JSON.stringify({
                                timestamp: resultData.timestamp,
                                userInfo: resultData.userInfo,
                                totalSamples: resultData.totalSamples,
                                evaluationItems: resultData.evaluationItems
                            }, null, 2)
                        }
                    }
                };
                
                // GitHub Personal Access Tokenï¼ˆè¨­å®šãŒå¿…è¦ï¼‰
                const GITHUB_TOKEN = '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'; // ã“ã“ã‚’å¤‰æ›´
                
                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(gistData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('GitHub Gistä¿å­˜æˆåŠŸ:', result);
                    showSaveSuccess('GitHub Gist', result.html_url);
                    return result.html_url;
                } else {
                    throw new Error(`GitHub Gist API ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }
                
            } catch (error) {
                console.error('GitHub Gistä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showSaveError('GitHub Gist', error.message);
                return false;
            }
        }

        // ä¿å­˜æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showSaveSuccess(platform = 'ã‚µãƒ¼ãƒãƒ¼', url = null) {
            const successDiv = document.createElement('div');
            let message = `âœ… ãƒ‡ãƒ¼ã‚¿ãŒ${platform}ã«æ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼`;
            if (url) {
                message += `<br><a href="${url}" target="_blank" style="color: #155724; text-decoration: underline;">ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª</a>`;
            }
            successDiv.innerHTML = `
                <div style="background: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 12px; border-radius: 5px; margin: 10px 0;">
                    ${message}
                </div>
            `;
            document.querySelector('.results-summary').appendChild(successDiv);
        }

        // ä¿å­˜ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showSaveError(platform = 'ã‚µãƒ¼ãƒãƒ¼', errorMessage) {
            const errorDiv = document.createElement('div');
            errorDiv.innerHTML = `
                <div style="background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 12px; border-radius: 5px; margin: 10px 0;">
                    âŒ ${platform}ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorMessage}<br>
                    <small>ãƒ­ãƒ¼ã‚«ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚</small>
                </div>
            `;
            document.querySelector('.results-summary').appendChild(errorDiv);
        }

        // çµæœãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»ä¿å­˜
        async function downloadResults() {
            const resultData = {
                timestamp: new Date().toISOString(),
                userInfo: userInfo,
                totalSamples: audioSamples.length,
                evaluationItems: evaluationItems,
                results: evaluationResults
            };
            
            // GitHub Gistã«ä¿å­˜ã‚’è©¦è¡Œï¼ˆæ¨å¥¨ï¼‰
            const gistUrl = await saveResultsToGitHubGist(resultData);
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚‚å®Ÿè¡Œ
            downloadResultsAsCSV(resultData);
        }

        // è©•ä¾¡ã‚’ã‚„ã‚Šç›´ã—
        function restartEvaluation() {
            document.getElementById('completion-screen').style.display = 'none';
            document.getElementById('start-screen').style.display = 'block';
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('age').value = '';
            document.getElementById('gender').value = '';
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('evaluation-screen').style.display !== 'none') {
                if (event.key === 'ArrowLeft' && !document.getElementById('prev-btn').disabled) {
                    previousSample();
                } else if (event.key === 'ArrowRight' && !document.getElementById('next-btn').disabled) {
                    nextSample();
                } else if (event.key === ' ') {
                    event.preventDefault();
                    replayAudio();
                } else if (event.key === 'd' && event.ctrlKey) {
                    // Ctrl+D ã§ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
                    event.preventDefault();
                    toggleDebugMode();
                }
            }
        });

        // æœ¬ç•ªç”¨ï¼šãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’éš ã™
        // document.addEventListener('DOMContentLoaded', function() {
        //     document.getElementById('debug-info').classList.add('hidden');
        // });
    </script>
</body>
</html>
